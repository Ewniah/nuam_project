{% extends 'base.html' %}
{% load static %}

{% block title %}{{ form.instance.pk|yesno:"Editar,Nueva" }} Calificaci√≥n Tributaria - NUAM{% endblock %}
{% block navbar_section %}{{ form.instance.pk|yesno:"Editar,Nueva" }} Calificaci√≥n{% endblock %}

{% block extra_css %}
<style>
    /* ===== NUAM WHITE/ORANGE THEME ===== */
    :root {
        --nuam-orange: #F37021;
        --nuam-navy: #002A4E;
        --nuam-light-gray: #F8F9FA;
        --nuam-border: #DEE2E6;
    }
    
    .page-header {
        background: linear-gradient(135deg, var(--nuam-navy) 0%, #003d70 100%);
        color: white;
        padding: 2rem;
        border-radius: 8px;
        margin-bottom: 2rem;
        box-shadow: 0 2px 8px rgba(0, 42, 78, 0.15);
    }
    
    .section-card {
        background: white;
        border: 1px solid var(--nuam-border);
        border-radius: 8px;
        margin-bottom: 1.5rem;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        overflow: hidden;
    }
    
    .section-header {
        background: var(--nuam-light-gray);
        border-bottom: 3px solid var(--nuam-orange);
        padding: 1rem 1.5rem;
    }
    
    .section-header h5 {
        margin: 0;
        color: var(--nuam-navy);
        font-weight: 600;
        font-size: 1.1rem;
    }
    
    .section-header .section-number {
        display: inline-block;
        background: var(--nuam-orange);
        color: white;
        width: 32px;
        height: 32px;
        line-height: 32px;
        text-align: center;
        border-radius: 50%;
        margin-right: 0.75rem;
        font-weight: 700;
    }
    
    .section-body {
        padding: 1.5rem;
    }
    
    .btn-nuam {
        background: var(--nuam-orange);
        border: none;
        color: white;
        padding: 0.625rem 1.5rem;
        font-weight: 500;
        border-radius: 6px;
        transition: all 0.3s ease;
    }
    
    .btn-nuam:hover {
        background: #d96419;
        color: white;
        transform: translateY(-1px);
        box-shadow: 0 4px 8px rgba(243, 112, 33, 0.3);
    }
    
    .btn-nuam:active {
        transform: translateY(0);
    }
    
    .form-label {
        font-weight: 500;
        color: #495057;
        margin-bottom: 0.5rem;
    }
    
    .form-label.required::after {
        content: " *";
        color: #dc3545;
    }
    
    .form-control:focus,
    .form-select:focus {
        border-color: var(--nuam-orange);
        box-shadow: 0 0 0 0.2rem rgba(243, 112, 33, 0.25);
    }
    
    .toggle-buttons {
        display: flex;
        gap: 1rem;
        margin-bottom: 1.5rem;
    }
    
    .toggle-buttons .btn-check:checked + .btn {
        background: var(--nuam-orange);
        border-color: var(--nuam-orange);
        color: white;
    }
    
    .calculator-panel {
        background: #f8f9fa;
        border: 2px dashed #dee2e6;
        border-radius: 8px;
        padding: 1.5rem;
        margin-top: 1rem;
    }
    
    .calculator-panel.hidden {
        display: none;
    }
    
    .monto-input-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
        gap: 1rem;
        margin-bottom: 1.5rem;
    }
    
    .monto-input-item label {
        font-size: 0.875rem;
        font-weight: 500;
        color: #6c757d;
        margin-bottom: 0.25rem;
    }
    
    .factor-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
        gap: 1rem;
    }
    
    .factor-item {
        position: relative;
    }
    
    .factor-item label {
        font-size: 0.875rem;
        font-weight: 500;
        margin-bottom: 0.25rem;
        color: #495057;
    }
    
    .factor-item input {
        font-family: 'Courier New', monospace;
        font-size: 0.9rem;
    }
    
    .critical-factors {
        background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
        border: 2px solid #2196f3;
        border-radius: 8px;
        padding: 1.5rem;
        margin-bottom: 1.5rem;
    }
    
    .critical-factors h6 {
        color: #1565c0;
        font-weight: 600;
        margin-bottom: 1rem;
    }
    
    .secondary-factors {
        padding: 1.5rem;
        background: #fafafa;
        border-radius: 8px;
    }
    
    .validation-warning {
        background: #fff3cd;
        border: 2px solid #ffc107;
        border-radius: 6px;
        padding: 1rem;
        margin-bottom: 1.5rem;
    }
    
    .validation-warning i {
        color: #ff9800;
    }
    
    .suma-display {
        display: inline-block;
        background: white;
        border: 2px solid #dee2e6;
        padding: 0.5rem 1rem;
        border-radius: 6px;
        font-family: 'Courier New', monospace;
        font-weight: 600;
        font-size: 1.1rem;
    }
    
    .suma-display.valid {
        border-color: #28a745;
        color: #28a745;
    }
    
    .suma-display.invalid {
        border-color: #dc3545;
        color: #dc3545;
        animation: pulse 1s infinite;
    }
    
    @keyframes pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.7; }
    }
    
    .alert-nuam {
        background: #fff3e0;
        border-left: 4px solid var(--nuam-orange);
        color: #e65100;
    }
    
    /* Campos bloqueados / readonly */
    .form-control[readonly],
    .form-select[disabled] {
        background-color: #f8f9fa !important;
        cursor: not-allowed !important;
        opacity: 0.7;
        border-color: #ced4da;
    }
    
    .form-control[readonly]:focus,
    .form-select[disabled]:focus {
        box-shadow: none;
        border-color: #ced4da;
    }
    
    /* Badge para campos protegidos */
    .badge-locked {
        display: inline-block;
        background: #6c757d;
        color: white;
        font-size: 0.7rem;
        padding: 0.2rem 0.5rem;
        border-radius: 4px;
        margin-left: 0.5rem;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid px-4 py-3">
    
    <!-- ========================================
         PAGE HEADER
         ======================================== -->
    <div class="page-header">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <h2 class="mb-2">
                    <i class="fas fa-file-invoice me-2"></i>
                    {{ form.instance.pk|yesno:"Editar,Nueva" }} Calificaci√≥n Tributaria
                </h2>
                <p class="mb-0 opacity-75">
                    Complete los datos requeridos para registrar la calificaci√≥n seg√∫n DJ 1949 o 1922.
                </p>
            </div>
            <a href="{% url 'listar_calificaciones' %}" class="btn btn-light">
                <i class="fas fa-arrow-left me-2"></i>Volver al Listado
            </a>
        </div>
    </div>
    
    <!-- Form Errors -->
    {% if form.errors %}
    <div class="alert alert-danger alert-dismissible fade show" role="alert">
        <h6 class="mb-2">
            <i class="fas fa-exclamation-triangle me-2"></i>
            <strong>Errores de Validaci√≥n:</strong>
        </h6>
        <ul class="mb-0">
            {% for field, errors in form.errors.items %}
                {% for error in errors %}
                    <li>{{ field|title }}: {{ error }}</li>
                {% endfor %}
            {% endfor %}
        </ul>
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
    {% endif %}
    
    <!-- Form -->
    <form method="post" id="formCalificacion" novalidate>
        {% csrf_token %}
        
        <!-- ========================================
             SECCI√ìN A: DATOS ADMINISTRATIVOS
             ======================================== -->
        <div class="section-card">
            <div class="section-header">
                <h5>
                    <span class="section-number">1</span>
                    <i class="fas fa-building me-2"></i>
                    Identificaci√≥n del Evento
                </h5>
            </div>
            <div class="section-body">
                <div class="row g-3">
                    <!-- Instrumento -->
                    <div class="col-md-4">
                        <label for="{{ form.instrumento.id_for_label }}" class="form-label required">
                            {{ form.instrumento.label }}
                            {% if calificacion.pk %}
                            <span class="badge-locked">
                                <i class="fas fa-lock me-1"></i>Bloqueado en edici√≥n
                            </span>
                            {% endif %}
                        </label>
                        {{ form.instrumento }}
                        {% if calificacion.pk %}
                        <small class="form-text text-muted">
                            <i class="fas fa-shield-alt text-warning"></i> No puede modificar el instrumento en modo edici√≥n (integridad de datos)
                        </small>
                        {% endif %}
                        {% if form.instrumento.errors %}
                            <div class="text-danger small mt-1">{{ form.instrumento.errors.0 }}</div>
                        {% endif %}
                    </div>
                    
                    <!-- Fecha Informe -->
                    <div class="col-md-4">
                        <label for="{{ form.fecha_informe.id_for_label }}" class="form-label required">
                            {{ form.fecha_informe.label }}
                        </label>
                        {{ form.fecha_informe }}
                    </div>
                    
                    <!-- Mercado -->
                    <div class="col-md-4">
                        <label for="{{ form.mercado.id_for_label }}" class="form-label required">
                            {{ form.mercado.label }}
                        </label>
                        {{ form.mercado }}
                    </div>
                    
                    <!-- Secuencia -->
                    <div class="col-md-4">
                        <label for="{{ form.secuencia.id_for_label }}" class="form-label required">
                            {{ form.secuencia.label }}
                        </label>
                        {{ form.secuencia }}
                    </div>
                    
                    <!-- N√∫mero Dividendo -->
                    <div class="col-md-4">
                        <label for="{{ form.numero_dividendo.id_for_label }}" class="form-label">
                            {{ form.numero_dividendo.label }}
                        </label>
                        {{ form.numero_dividendo }}
                    </div>
                    
                    <!-- Tipo Sociedad -->
                    <div class="col-md-4">
                        <label for="{{ form.tipo_sociedad.id_for_label }}" class="form-label">
                            {{ form.tipo_sociedad.label }}
                        </label>
                        {{ form.tipo_sociedad }}
                    </div>
                    
                    <!-- Valor Hist√≥rico -->
                    <div class="col-md-4">
                        <label for="{{ form.valor_historico.id_for_label }}" class="form-label">
                            {{ form.valor_historico.label }}
                        </label>
                        {{ form.valor_historico }}
                    </div>
                    
                    <!-- N√∫mero DJ -->
                    <div class="col-md-4">
                        <label for="{{ form.numero_dj.id_for_label }}" class="form-label">
                            {{ form.numero_dj.label }}
                            <span class="badge-locked">
                                <i class="fas fa-lock me-1"></i>Bloqueado
                            </span>
                        </label>
                        {{ form.numero_dj }}
                        <small class="form-text text-muted">
                            <i class="fas fa-magic text-primary"></i> Se asigna autom√°ticamente seg√∫n el tipo de instrumento
                        </small>
                    </div>
                    
                    <!-- Ejercicio -->
                    <div class="col-md-4">
                        <label for="{{ form.ejercicio.id_for_label }}" class="form-label">
                            {{ form.ejercicio.label }}
                        </label>
                        {{ form.ejercicio }}
                    </div>
                    
                    <!-- Observaciones -->
                    <div class="col-12">
                        <label for="{{ form.observaciones.id_for_label }}" class="form-label">
                            {{ form.observaciones.label }}
                        </label>
                        {{ form.observaciones }}
                        <small class="form-text text-muted">Comentarios adicionales sobre la calificaci√≥n</small>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- ========================================
             SECCI√ìN B: CALCULADORA
             ======================================== -->
        <div class="section-card">
            <div class="section-header">
                <h5>
                    <span class="section-number">2</span>
                    <i class="fas fa-calculator me-2"></i>
                    Definici√≥n de Valores
                </h5>
            </div>
            <div class="section-body">
                
                <!-- Toggle: Modo Ingreso -->
                <div class="alert alert-nuam">
                    <i class="fas fa-info-circle me-2"></i>
                    <strong>Seleccione el m√©todo de ingreso:</strong> Puede calcular factores autom√°ticamente desde montos o ingresarlos manualmente.
                </div>
                
                <div class="toggle-buttons">
                    <input type="radio" class="btn-check" name="modo_ingreso" id="modo_monto" value="monto" autocomplete="off" checked>
                    <label class="btn btn-outline-primary" for="modo_monto">
                        <i class="fas fa-dollar-sign me-2"></i>
                        Ingreso por Monto
                    </label>
                    
                    <input type="radio" class="btn-check" name="modo_ingreso" id="modo_factor" value="factor" autocomplete="off">
                    <label class="btn btn-outline-primary" for="modo_factor">
                        <i class="fas fa-percent me-2"></i>
                        Ingreso por Factor
                    </label>
                </div>
                
                <!-- Calculadora de Montos -->
                <div id="calculadora-panel" class="calculator-panel">
                    <h6 class="mb-3">
                        <i class="fas fa-coins me-2 text-warning"></i>
                        Ingreso de Montos para C√°lculo Autom√°tico
                    </h6>
                    <p class="text-muted small mb-3">
                        Ingrese el monto base y los montos correspondientes a cada factor. El sistema calcular√° autom√°ticamente los factores proporcionales.
                    </p>
                    
                    <!-- Monto Base -->
                    <div class="mb-4">
                        <label for="{{ form.monto.id_for_label }}" class="form-label fw-bold">
                            <i class="fas fa-dollar-sign text-success me-2"></i>
                            Monto Total / Base ($)
                        </label>
                        <div class="input-group mb-3">
                            <span class="input-group-text bg-light">
                                <i class="fas fa-dollar-sign text-success"></i>
                            </span>
                            {{ form.monto }}
                            <button type="button" id="btn-calcular-simple" class="btn btn-success">
                                <i class="fas fa-calculator me-2"></i>Calcular Factores
                            </button>
                        </div>
                        <small class="form-text text-muted">
                            <i class="fas fa-info-circle me-1"></i>
                            Ingrese el monto total y presione "Calcular Factores" para distribuirlo autom√°ticamente entre los 30 factores
                        </small>
                    </div>
                    
                    <hr class="my-4">
                    
                    <h6 class="mb-3 text-muted">
                        <i class="fas fa-list-ol me-2"></i>
                        Desglose de Montos por Factor (Opcional)
                    </h6>
                    <p class="text-muted small mb-3">
                        O ingrese montos individuales para cada factor si necesita un c√°lculo m√°s detallado.
                    </p>
                    
                    <!-- Grid de inputs de montos (generados din√°micamente) -->
                    <div class="monto-input-grid" id="montos-container">
                        <!-- JavaScript generar√° los 30 inputs aqu√≠ -->
                    </div>
                    
                    <!-- Botones de Acci√≥n -->
                    <div class="d-flex justify-content-end gap-2">
                        <button type="button" id="btn-limpiar-montos" class="btn btn-outline-secondary">
                            <i class="fas fa-eraser me-2"></i>Limpiar Montos
                        </button>
                        <button type="button" id="btn-calcular" class="btn btn-nuam">
                            <i class="fas fa-calculator me-2"></i>
                            <span id="btn-calcular-text">Calcular Factores</span>
                            <span id="btn-calcular-spinner" class="spinner-border spinner-border-sm ms-2 d-none"></span>
                        </button>
                    </div>
                </div>
                
            </div>
        </div>
        
        <!-- ========================================
             SECCI√ìN C: GRILLA DE FACTORES
             ======================================== -->
        <div class="section-card">
            <div class="section-header">
                <h5>
                    <span class="section-number">3</span>
                    <i class="fas fa-chart-line me-2"></i>
                    Detalle de Factores (DJ 1949)
                </h5>
            </div>
            <div class="section-body">
                
                <!-- Warning: Validaci√≥n -->
                <div class="validation-warning">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            <strong>REGLA B de Validaci√≥n:</strong> La suma de factores 8-16 no debe superar 1.0
                        </div>
                        <div class="suma-display" id="suma-criticos">
                            0.00000000
                        </div>
                    </div>
                </div>
                
                <!-- FACTORES CR√çTICOS (8-16) -->
                <div class="critical-factors">
                    <h6>
                        <i class="fas fa-exclamation-circle me-2"></i>
                        Factores Cr√≠ticos (8-16)
                    </h6>
                    <div class="factor-grid">
                        <div class="factor-item">
                            <label for="id_factor_8" class="form-label">Factor 8</label>
                            {{ form.factor_8 }}
                        </div>
                        <div class="factor-item">
                            <label for="id_factor_9" class="form-label">Factor 9</label>
                            {{ form.factor_9 }}
                        </div>
                        <div class="factor-item">
                            <label for="id_factor_10" class="form-label">Factor 10</label>
                            {{ form.factor_10 }}
                        </div>
                        <div class="factor-item">
                            <label for="id_factor_11" class="form-label">Factor 11</label>
                            {{ form.factor_11 }}
                        </div>
                        <div class="factor-item">
                            <label for="id_factor_12" class="form-label">Factor 12</label>
                            {{ form.factor_12 }}
                        </div>
                        <div class="factor-item">
                            <label for="id_factor_13" class="form-label">Factor 13</label>
                            {{ form.factor_13 }}
                        </div>
                        <div class="factor-item">
                            <label for="id_factor_14" class="form-label">Factor 14</label>
                            {{ form.factor_14 }}
                        </div>
                        <div class="factor-item">
                            <label for="id_factor_15" class="form-label">Factor 15</label>
                            {{ form.factor_15 }}
                        </div>
                        <div class="factor-item">
                            <label for="id_factor_16" class="form-label">Factor 16</label>
                            {{ form.factor_16 }}
                        </div>
                    </div>
                </div>
                
                <!-- FACTORES SECUNDARIOS (17-37) -->
                <div class="secondary-factors">
                    <h6 class="mb-3" style="color: #6c757d;">
                        <i class="fas fa-layer-group me-2"></i>
                        Factores Secundarios (17-37)
                    </h6>
                    <div class="factor-grid">
                        <div class="factor-item">
                            <label for="id_factor_17" class="form-label">Factor 17</label>
                            {{ form.factor_17 }}
                        </div>
                        <div class="factor-item">
                            <label for="id_factor_18" class="form-label">Factor 18</label>
                            {{ form.factor_18 }}
                        </div>
                        <div class="factor-item">
                            <label for="id_factor_19" class="form-label">Factor 19</label>
                            {{ form.factor_19 }}
                        </div>
                        <div class="factor-item">
                            <label for="id_factor_20" class="form-label">Factor 20</label>
                            {{ form.factor_20 }}
                        </div>
                        <div class="factor-item">
                            <label for="id_factor_21" class="form-label">Factor 21</label>
                            {{ form.factor_21 }}
                        </div>
                        <div class="factor-item">
                            <label for="id_factor_22" class="form-label">Factor 22</label>
                            {{ form.factor_22 }}
                        </div>
                        <div class="factor-item">
                            <label for="id_factor_23" class="form-label">Factor 23</label>
                            {{ form.factor_23 }}
                        </div>
                        <div class="factor-item">
                            <label for="id_factor_24" class="form-label">Factor 24</label>
                            {{ form.factor_24 }}
                        </div>
                        <div class="factor-item">
                            <label for="id_factor_25" class="form-label">Factor 25</label>
                            {{ form.factor_25 }}
                        </div>
                        <div class="factor-item">
                            <label for="id_factor_26" class="form-label">Factor 26</label>
                            {{ form.factor_26 }}
                        </div>
                        <div class="factor-item">
                            <label for="id_factor_27" class="form-label">Factor 27</label>
                            {{ form.factor_27 }}
                        </div>
                        <div class="factor-item">
                            <label for="id_factor_28" class="form-label">Factor 28</label>
                            {{ form.factor_28 }}
                        </div>
                        <div class="factor-item">
                            <label for="id_factor_29" class="form-label">Factor 29</label>
                            {{ form.factor_29 }}
                        </div>
                        <div class="factor-item">
                            <label for="id_factor_30" class="form-label">Factor 30</label>
                            {{ form.factor_30 }}
                        </div>
                        <div class="factor-item">
                            <label for="id_factor_31" class="form-label">Factor 31</label>
                            {{ form.factor_31 }}
                        </div>
                        <div class="factor-item">
                            <label for="id_factor_32" class="form-label">Factor 32</label>
                            {{ form.factor_32 }}
                        </div>
                        <div class="factor-item">
                            <label for="id_factor_33" class="form-label">Factor 33</label>
                            {{ form.factor_33 }}
                        </div>
                        <div class="factor-item">
                            <label for="id_factor_34" class="form-label">Factor 34</label>
                            {{ form.factor_34 }}
                        </div>
                        <div class="factor-item">
                            <label for="id_factor_35" class="form-label">Factor 35</label>
                            {{ form.factor_35 }}
                        </div>
                        <div class="factor-item">
                            <label for="id_factor_36" class="form-label">Factor 36</label>
                            {{ form.factor_36 }}
                        </div>
                        <div class="factor-item">
                            <label for="id_factor_37" class="form-label">Factor 37</label>
                            {{ form.factor_37 }}
                        </div>
                    </div>
                </div>
                
            </div>
        </div>
        
        <!-- ========================================
             SECCI√ìN D: ESTADO Y ACCIONES
             ======================================== -->
        <div class="section-card">
            <div class="section-header">
                <h5>
                    <span class="section-number">4</span>
                    <i class="fas fa-toggle-on me-2"></i>
                    Estado y Guardar
                </h5>
            </div>
            <div class="section-body">
                <div class="row g-3">
                    <!-- Estado Activo -->
                    <div class="col-12">
                        <div class="form-check form-switch">
                            {{ form.activo }}
                            <label class="form-check-label" for="{{ form.activo.id_for_label }}">
                                <i class="fas fa-check-circle me-2 text-success"></i>
                                {{ form.activo.label }}
                            </label>
                            <small class="form-text text-muted d-block mt-1">
                                Marque esta opci√≥n si desea que la calificaci√≥n est√© activa en el sistema
                            </small>
                        </div>
                    </div>
                    
                    <!-- Botones de Acci√≥n -->
                    <div class="col-12 mt-4">
                        <div class="d-flex gap-2">
                            <button type="submit" class="btn btn-nuam px-4">
                                <i class="fas fa-save me-2"></i>Guardar Calificaci√≥n
                            </button>
                            <a href="{% url 'listar_calificaciones' %}" class="btn btn-outline-secondary px-4">
                                <i class="fas fa-times me-2"></i>Cancelar
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
    </form>
    
</div>
{% endblock %}

{% block extra_js %}
<script>
    // ========================================
    // CONFIGURACI√ìN
    // ========================================
    const AJAX_URL = "{% url 'calcular_factores_ajax' %}";
    const CSRF_TOKEN = "{{ csrf_token }}";
    const TOTAL_FACTORES = 30;
    
    // Mapa de instrumentos para autoselecci√≥n de DJ
    const INSTRUMENTOS_MAP = {{ instrumentos_map_json|safe }};
    
    document.addEventListener('DOMContentLoaded', function() {
        console.log('üöÄ Inicializando formulario de calificaci√≥n...');
        
        // ========================================
        // 0. SECURITY: BLOQUEAR CAMPOS CR√çTICOS
        // ========================================
        const instrumentoSelect = document.getElementById('id_instrumento');
        const numeroDjInput = document.getElementById('id_numero_dj');
        const esEdicion = {{ calificacion.pk|yesno:"true,false" }};
        
        // BLOQUEAR n√∫mero DJ (siempre readonly - se calcula autom√°ticamente)
        if (numeroDjInput) {
            numeroDjInput.readOnly = true;
            numeroDjInput.classList.add('bg-light');
            numeroDjInput.style.cursor = 'not-allowed';
        }
        
        // BLOQUEAR instrumento en modo EDICI√ìN (integridad de datos)
        if (esEdicion && instrumentoSelect) {
            instrumentoSelect.disabled = true;
            instrumentoSelect.classList.add('bg-light');
            instrumentoSelect.style.cursor = 'not-allowed';
            
            // Agregar campo hidden para enviar el valor
            const hiddenInput = document.createElement('input');
            hiddenInput.type = 'hidden';
            hiddenInput.name = 'instrumento';
            hiddenInput.value = instrumentoSelect.value;
            instrumentoSelect.parentNode.appendChild(hiddenInput);
            
            console.log('üîí Instrumento bloqueado en modo edici√≥n (ID:', instrumentoSelect.value, ')');
        }
        
        // ========================================
        // 1. AUTOSELECCI√ìN DE DJ BASADO EN INSTRUMENTO
        // ========================================
        
        if (instrumentoSelect && numeroDjInput) {
            instrumentoSelect.addEventListener('change', function() {
                const instrumentoId = this.value;
                
                if (instrumentoId && INSTRUMENTOS_MAP[instrumentoId]) {
                    const djRecomendado = INSTRUMENTOS_MAP[instrumentoId].dj;
                    const tipoInstrumento = INSTRUMENTOS_MAP[instrumentoId].tipo;
                    
                    // Actualizar campo DJ autom√°ticamente
                    numeroDjInput.value = djRecomendado;
                    
                    // Feedback visual
                    numeroDjInput.style.background = '#e7f3ff';
                    numeroDjInput.style.borderColor = '#2196f3';
                    
                    console.log(`‚úÖ DJ ${djRecomendado} asignado autom√°ticamente (Instrumento: ${tipoInstrumento})`);
                    
                    // Mostrar notificaci√≥n
                    mostrarNotificacion(
                        `DJ ${djRecomendado} seleccionado autom√°ticamente para ${tipoInstrumento}`,
                        'info'
                    );
                    
                    // Restaurar estilo despu√©s de 2 segundos
                    setTimeout(() => {
                        numeroDjInput.style.background = '';
                        numeroDjInput.style.borderColor = '';
                    }, 2000);
                } else if (!instrumentoId) {
                    // Limpiar si no hay instrumento seleccionado
                    numeroDjInput.value = '';
                }
            });
            
            // Aplicar autom√°ticamente si ya hay un instrumento seleccionado (edici√≥n)
            if (instrumentoSelect.value) {
                const event = new Event('change');
                instrumentoSelect.dispatchEvent(event);
            }
        }
        
        // ========================================
        // 2. TOGGLE MODO MONTO/FACTOR
        // ========================================
        const modoMonto = document.getElementById('modo_monto');
        const modoFactor = document.getElementById('modo_factor');
        const calculadoraPanel = document.getElementById('calculadora-panel');
        
        function toggleModo() {
            const esModoMonto = modoMonto.checked;
            
            if (esModoMonto) {
                calculadoraPanel.classList.remove('hidden');
                // En modo monto, los factores se calculan autom√°ticamente
                for (let i = 8; i <= 37; i++) {
                    const factorInput = document.getElementById(`id_factor_${i}`);
                    if (factorInput) {
                        factorInput.readOnly = true;
                        factorInput.style.background = '#e9ecef';
                    }
                }
            } else {
                calculadoraPanel.classList.add('hidden');
                // En modo factor, se pueden editar manualmente
                for (let i = 8; i <= 37; i++) {
                    const factorInput = document.getElementById(`id_factor_${i}`);
                    if (factorInput) {
                        factorInput.readOnly = false;
                        factorInput.style.background = 'white';
                    }
                }
            }
        }
        
        modoMonto.addEventListener('change', toggleModo);
        modoFactor.addEventListener('change', toggleModo);
        toggleModo(); // Inicializar
        
        // ========================================
        // 2. GENERAR INPUTS DE MONTOS
        // ========================================
        const montosContainer = document.getElementById('montos-container');
        
        for (let i = 8; i <= 37; i++) {
            const div = document.createElement('div');
            div.className = 'monto-input-item';
            div.innerHTML = `
                <label for="monto_${i}">Monto ${i}</label>
                <input type="number" 
                       id="monto_${i}" 
                       class="form-control monto-input" 
                       step="0.01" 
                       min="0"
                       placeholder="0.00">
            `;
            montosContainer.appendChild(div);
        }
        
        // ========================================
        // 3A. CALCULAR DESDE MONTO BASE (SIMPLE)
        // ========================================
        const btnCalcularSimple = document.getElementById('btn-calcular-simple');
        const montoBaseInput = document.getElementById('id_monto');
        
        if (btnCalcularSimple && montoBaseInput) {
            btnCalcularSimple.addEventListener('click', async function() {
                const montoBase = parseFloat(montoBaseInput.value);
                
                if (!montoBase || montoBase <= 0) {
                    mostrarNotificacion('Por favor, ingrese un Monto Base v√°lido', 'error');
                    return;
                }
                
                console.log('üßÆ Calculando factores desde monto base:', montoBase);
                
                // UI: Mostrar loading
                btnCalcularSimple.disabled = true;
                btnCalcularSimple.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Calculando...';
                
                // Distribuir el monto base equitativamente entre los 30 factores
                const montoPorFactor = montoBase / 30;
                
                // Recopilar montos distribuidos
                const formData = new FormData();
                for (let i = 8; i <= 37; i++) {
                    formData.append(`monto_${i}`, montoPorFactor.toString());
                }
                
                try {
                    const response = await fetch(AJAX_URL, {
                        method: 'POST',
                        headers: {
                            'X-CSRFToken': CSRF_TOKEN
                        },
                        body: formData
                    });
                    
                    const data = await response.json();
                    
                    if (data.success) {
                        console.log('‚úÖ Factores calculados desde base:', data);
                        
                        // Poblar factores
                        for (let i = 8; i <= 37; i++) {
                            const factorInput = document.getElementById(`id_factor_${i}`);
                            if (factorInput && data.factores[`factor_${i}`]) {
                                factorInput.value = data.factores[`factor_${i}`];
                            }
                        }
                        
                        // Actualizar suma de cr√≠ticos
                        actualizarSumaCriticos();
                        
                        // Mensaje de √©xito
                        mostrarNotificacion(`Factores calculados desde monto base: $${montoBase.toLocaleString()}`, 'success');
                    } else {
                        console.error('‚ùå Error en c√°lculo:', data.error);
                        mostrarNotificacion(data.error, 'error');
                    }
                    
                } catch (error) {
                    console.error('‚ùå Error de red:', error);
                    mostrarNotificacion('Error al comunicarse con el servidor', 'error');
                } finally {
                    // Restaurar bot√≥n
                    btnCalcularSimple.disabled = false;
                    btnCalcularSimple.innerHTML = '<i class="fas fa-calculator me-2"></i>Calcular desde Base';
                }
            });
        }
        
        // ========================================
        // 3B. CALCULAR FACTORES DETALLADO (AJAX)
        // ========================================
        const btnCalcular = document.getElementById('btn-calcular');
        const btnTexto = document.getElementById('btn-calcular-text');
        const btnSpinner = document.getElementById('btn-calcular-spinner');
        
        btnCalcular.addEventListener('click', async function() {
            console.log('üßÆ Calculando factores...');
            
            // UI: Mostrar loading
            btnCalcular.disabled = true;
            btnTexto.textContent = 'Calculando...';
            btnSpinner.classList.remove('d-none');
            
            // Recopilar montos
            const formData = new FormData();
            for (let i = 8; i <= 37; i++) {
                const montoInput = document.getElementById(`monto_${i}`);
                formData.append(`monto_${i}`, montoInput.value || '0');
            }
            
            try {
                const response = await fetch(AJAX_URL, {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': CSRF_TOKEN
                    },
                    body: formData
                });
                
                const data = await response.json();
                
                if (data.success) {
                    console.log('‚úÖ Factores calculados:', data);
                    
                    // Poblar factores
                    for (let i = 8; i <= 37; i++) {
                        const factorInput = document.getElementById(`id_factor_${i}`);
                        if (factorInput && data.factores[`factor_${i}`]) {
                            factorInput.value = data.factores[`factor_${i}`];
                        }
                    }
                    
                    // Actualizar suma de cr√≠ticos
                    actualizarSumaCriticos();
                    
                    // Mensaje de √©xito
                    mostrarNotificacion('Factores calculados correctamente', 'success');
                } else {
                    console.error('‚ùå Error en c√°lculo:', data.error);
                    mostrarNotificacion(data.error, 'error');
                }
                
            } catch (error) {
                console.error('‚ùå Error de red:', error);
                mostrarNotificacion('Error al comunicarse con el servidor', 'error');
            } finally {
                // Restaurar bot√≥n
                btnCalcular.disabled = false;
                btnTexto.textContent = 'Calcular Factores';
                btnSpinner.classList.add('d-none');
            }
        });
        
        // ========================================
        // 4. LIMPIAR MONTOS
        // ========================================
        const btnLimpiar = document.getElementById('btn-limpiar-montos');
        btnLimpiar.addEventListener('click', function() {
            for (let i = 8; i <= 37; i++) {
                const montoInput = document.getElementById(`monto_${i}`);
                if (montoInput) montoInput.value = '';
                
                const factorInput = document.getElementById(`id_factor_${i}`);
                if (factorInput) factorInput.value = '';
            }
            actualizarSumaCriticos();
            mostrarNotificacion('Montos y factores limpiados', 'info');
        });
        
        // ========================================
        // 5. SUMA DE FACTORES CR√çTICOS EN TIEMPO REAL
        // ========================================
        function actualizarSumaCriticos() {
            let suma = 0;
            for (let i = 8; i <= 16; i++) {
                const factorInput = document.getElementById(`id_factor_${i}`);
                if (factorInput && factorInput.value) {
                    suma += parseFloat(factorInput.value) || 0;
                }
            }
            
            const sumaDisplay = document.getElementById('suma-criticos');
            sumaDisplay.textContent = suma.toFixed(8);
            
            // Validaci√≥n visual
            if (suma > 1.0) {
                sumaDisplay.classList.add('invalid');
                sumaDisplay.classList.remove('valid');
            } else {
                sumaDisplay.classList.add('valid');
                sumaDisplay.classList.remove('invalid');
            }
        }
        
        // Escuchar cambios en factores cr√≠ticos
        for (let i = 8; i <= 16; i++) {
            const factorInput = document.getElementById(`id_factor_${i}`);
            if (factorInput) {
                factorInput.addEventListener('input', actualizarSumaCriticos);
            }
        }
        
        // Inicializar suma
        actualizarSumaCriticos();
        
        // ========================================
        // 6. VALIDACI√ìN PRE-SUBMIT
        // ========================================
        const form = document.getElementById('formCalificacion');
        form.addEventListener('submit', function(e) {
            // Verificar REGLA B
            let sumaCriticos = 0;
            for (let i = 8; i <= 16; i++) {
                const factorInput = document.getElementById(`id_factor_${i}`);
                sumaCriticos += parseFloat(factorInput.value) || 0;
            }
            
            if (sumaCriticos > 1.0) {
                e.preventDefault();
                mostrarNotificacion(
                    `REGLA B violada: La suma de factores 8-16 es ${sumaCriticos.toFixed(8)}, debe ser ‚â§ 1.0`,
                    'error'
                );
                return false;
            }
            
            console.log('‚úÖ Validaci√≥n pasada, enviando formulario...');
        });
        
        // ========================================
        // HELPERS
        // ========================================
        function mostrarNotificacion(mensaje, tipo) {
            const colores = {
                success: '#28a745',
                error: '#dc3545',
                info: '#17a2b8'
            };
            
            const iconos = {
                success: 'fa-check-circle',
                error: 'fa-exclamation-circle',
                info: 'fa-info-circle'
            };
            
            const notif = document.createElement('div');
            notif.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: white;
                color: ${colores[tipo]};
                padding: 1rem 1.5rem;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                border-left: 4px solid ${colores[tipo]};
                z-index: 9999;
                animation: slideIn 0.3s ease;
                max-width: 400px;
            `;
            notif.innerHTML = `<i class="fas ${iconos[tipo]} me-2"></i>${mensaje}`;
            document.body.appendChild(notif);
            
            setTimeout(() => {
                notif.style.animation = 'slideOut 0.3s ease';
                setTimeout(() => notif.remove(), 300);
            }, 3000);
        }
        
        // ========================================
        // 7. TOOLTIPS CONTEXTUALES - COBERTURA 100% (DJ 1949/1922)
        // ========================================
        
        const ALL_FIELD_DESCRIPTIONS = {
            // === CAMPOS ADMINISTRATIVOS ===
            'instrumento': 'Activo financiero sobre el cual se declara el dividendo. Seleccione el instrumento previamente registrado en el sistema.',
            'fecha_informe': 'Fecha oficial del evento o reparto del dividendo. Formato: DD/MM/AAAA. Esta fecha determina el ejercicio tributario aplicable.',
            'mercado': 'Mercado de origen del instrumento (Acciones, CFI, Fondos Mutuos). Define el tipo de operaci√≥n y normativa aplicable.',
            'secuencia': 'N√∫mero correlativo √∫nico del evento. Identifica de forma inequ√≠voca cada distribuci√≥n de dividendos en el sistema.',
            'numero_dividendo': 'N√∫mero identificador del dividendo seg√∫n registros de la entidad emisora. Permite trazabilidad con documentos oficiales.',
            'tipo_sociedad': 'Clasificaci√≥n jur√≠dica: <strong>A</strong> = Abierta (cotiza en bolsa), <strong>C</strong> = Cerrada (no cotiza). Afecta r√©gimen tributario.',
            'valor_historico': 'Valor del activo al momento del evento. Base hist√≥rica para c√°lculos de ganancias de capital y revalorizaciones.',
            'numero_dj': 'Declaraci√≥n Jurada aplicable seg√∫n normativa SII: <strong>1949</strong> (SA) o <strong>1922</strong> (otras sociedades). Campo calculado autom√°ticamente.',
            'ejercicio': 'A√±o tributario al que corresponde la calificaci√≥n (AAAA). Ej: 2024. Determina las reglas fiscales vigentes aplicables.',
            'metodo_ingreso': 'M√©todo de ingreso seleccionado: <strong>MONTO</strong> (ingresa monto y sistema calcula factores) o <strong>FACTOR</strong> (ingresa factores directamente).',
            'monto': 'Monto total l√≠quido a repartir en pesos chilenos (CLP). Base de c√°lculo para distribuci√≥n proporcional en los 30 factores.',
            
            // === FACTORES TRIBUTARIOS (8-37) - DJ 1949/1922 ===
            'factor_8': 'Con cr√©dito por IDPC generados a contar del 01.01.2017 (Art. 14 A N¬∞1 LIR). Rentas empresariales con derecho a cr√©dito tributario completo.',
            'factor_9': 'Con cr√©dito por IDPC acumulados hasta el 31.12.2016 (Art. 14 A N¬∞2 LIR). Rentas del r√©gimen transitorio con cr√©dito hist√≥rico.',
            'factor_10': 'Con derecho a cr√©dito por pago de IDPC voluntario (Art. 14 A N¬∞3 LIR). Empresas que optaron por r√©gimen semi-integrado con pago voluntario.',
            'factor_11': 'Sin derecho a cr√©dito (Art. 14 A N¬∞4 LIR). Utilidades sin beneficio tributario, t√≠picamente de empresas extranjeras o rentas exentas.',
            'factor_12': 'Rentas provenientes del registro RAP (Rentas Afectas a Pago) o Art. 14 TER A LIR. R√©gimen especial de tributaci√≥n simplificada.',
            'factor_13': 'Otras rentas percibidas sin prioridad de imputaci√≥n (Art. 14 A N¬∞5 LIR). Rentas residuales no clasificadas en otros factores.',
            'factor_14': 'Exceso de distribuciones desproporcionadas (DJ 1949 ¬ß14). Ajuste por repartos que exceden proporci√≥n accionaria en sociedades cerradas.',
            'factor_15': 'Utilidades afectas con ISFUT - Impuesto Sustitutivo Final √önico Tributaci√≥n (Ley 20.780 Art. 38 bis). Rentas hist√≥ricas con r√©gimen especial.',
            'factor_16': 'Rentas generadas hasta 31.12.1983 / ISFUT Ley 21.210 (DJ 1949 ¬ß16). Utilidades antiguas con tratamiento preferencial por antig√ºedad.',
            'factor_17': 'Rentas exentas del Impuesto Global Complementario (IGC). Ingresos no gravados para personas naturales residentes.',
            'factor_18': 'Ingresos no constitutivos de renta (Art. 17 LIR). Operaciones excluidas de base imponible por ley (herencias, seguros, etc.).',
            'factor_19': 'Rentas o cantidades con retenci√≥n final efectuada. Montos que ya tributaron en fuente y no requieren declaraci√≥n adicional.',
            'factor_20': 'Rentas no sujetas a tributaci√≥n en Chile. Ingresos de fuente extranjera o bajo tratados de doble tributaci√≥n.',
            'factor_21': 'Rentas sujetas a restituci√≥n de cr√©ditos (Art. 56 N¬∞3 LIR). Ajustes por uso indebido de cr√©ditos fiscales anteriores.',
            'factor_22': 'Cantidades que generan cr√©dito IPE (Impuesto Pagado en el Extranjero). Permite imputar impuestos pagados en jurisdicciones for√°neas.',
            'factor_23': 'Cr√©dito por donaciones (Art. 69 Ley 19.885). Beneficio tributario por aportes a entidades sin fines de lucro autorizadas.',
            'factor_24': 'Cr√©dito por inversiones en activos fijos (Art. 33 bis LIR). Incentivo fiscal por adquisici√≥n de bienes de capital productivos.',
            'factor_25': 'Otros cr√©ditos contra el impuesto. Cr√©ditos fiscales diversos no clasificados en factores anteriores (capacitaci√≥n, I+D, etc.).',
            'factor_26': 'P√©rdida tributaria arrastrable del ejercicio. D√©ficit operacional que puede compensarse en ejercicios futuros seg√∫n Art. 31 LIR.',
            'factor_27': 'Gastos rechazados agregados a la renta l√≠quida. Desembolsos no aceptados por SII y que incrementan base imponible (multas, lujo, etc.).',
            'factor_28': 'Ajustes por diferencias temporarias contables. Correcciones entre resultado contable y tributario (depreciaci√≥n, provisiones, etc.).',
            'factor_29': 'Rentas exentas de impuesto adicional (IA). Ingresos no gravados para no residentes bajo Art. 59 y siguientes LIR.',
            'factor_30': 'Cantidades no gravadas por beneficios especiales. Montos protegidos por leyes sectoriales (zonas francas, incentivos regionales).',
            'factor_31': 'Dividendos de sociedades extranjeras (DJ 1949 ¬ß31). Utilidades recibidas desde empresas del exterior, sujetas a Art. 41 A LIR.',
            'factor_32': 'Rentas de fondos de inversi√≥n privados (FIP). Resultados de veh√≠culos de inversi√≥n colectiva regulados por SVS/CMF.',
            'factor_33': 'Ganancias de capital en acciones (Art. 17 N¬∞8 LIR). Mayor valor en venta de t√≠tulos accionarios con tratamiento preferencial.',
            'factor_34': 'Retiros o dividendos afectos a impuesto √∫nico (35% Art. 21 LIR). Distribuciones de gastos rechazados con tasa fija sin derecho a cr√©dito.',
            'factor_35': 'Rentas del Art. 20 N¬∞2 LIR (actividades profesionales). Honorarios y servicios personales de trabajadores independientes.',
            'factor_36': 'Cantidades reinvertidas con suspensi√≥n de impuestos. Utilidades destinadas a capitalizaci√≥n que difieren tributaci√≥n (Art. 14 letra D N¬∞3).',
            'factor_37': 'Otras cantidades agregadas o rebajadas a la renta l√≠quida. Ajustes residuales diversos seg√∫n fiscalizaci√≥n o correcciones de declaraciones.'
        };
        
        // Agregar tooltips a TODOS los campos
        Object.keys(ALL_FIELD_DESCRIPTIONS).forEach(fieldId => {
            const label = document.querySelector(`label[for="id_${fieldId}"]`);
            if (label) {
                // Verificar si ya tiene un √≠cono de ayuda
                if (!label.querySelector('.fa-question-circle')) {
                    // Crear √≠cono de ayuda
                    const helpIcon = document.createElement('i');
                    helpIcon.className = 'fas fa-question-circle ms-2 text-muted';
                    helpIcon.style.cursor = 'help';
                    helpIcon.style.fontSize = '0.875rem';
                    helpIcon.setAttribute('data-bs-toggle', 'tooltip');
                    helpIcon.setAttribute('data-bs-placement', 'top');
                    helpIcon.setAttribute('data-bs-html', 'true');
                    helpIcon.setAttribute('title', `<small>${ALL_FIELD_DESCRIPTIONS[fieldId]}</small>`);
                    
                    label.appendChild(helpIcon);
                }
            }
        });
        
        // Inicializar tooltips de Bootstrap
        const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
        const tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
            return new bootstrap.Tooltip(tooltipTriggerEl, {
                boundary: 'window',
                customClass: 'tooltip-nuam'
            });
        });
        
        console.log(`‚ÑπÔ∏è ${tooltipTriggerList.length} tooltips inicializados`);
        console.log('‚úÖ Formulario inicializado correctamente');
    });
</script>

<style>
    @keyframes slideIn {
        from { transform: translateX(400px); opacity: 0; }
        to { transform: translateX(0); opacity: 1; }
    }
    
    @keyframes slideOut {
        from { transform: translateX(0); opacity: 1; }
        to { transform: translateX(400px); opacity: 0; }
    }
    
    /* Estilo personalizado para tooltips */
    .tooltip-nuam .tooltip-inner {
        background-color: var(--nuam-navy);
        color: white;
        text-align: left;
        max-width: 300px;
        padding: 0.75rem 1rem;
        font-size: 0.875rem;
        box-shadow: 0 4px 12px rgba(0, 42, 78, 0.3);
    }
    
    .tooltip-nuam .tooltip-arrow::before {
        border-top-color: var(--nuam-navy);
    }
    
    .form-label i.fa-question-circle:hover {
        color: var(--nuam-orange) !important;
        transform: scale(1.1);
        transition: all 0.2s ease;
    }
</style>
{% endblock %}
