{% extends 'base.html' %}
{% load static %}

{% block title %}{{ form.instance.pk|yesno:"Editar,Nueva" }} Calificaci√≥n Tributaria - NUAM{% endblock %}

{% block extra_css %}
<style>
    /* ===== NUAM WHITE/ORANGE THEME ===== */
    :root {
        --nuam-orange: #F37021;
        --nuam-navy: #002A4E;
        --nuam-light-gray: #F8F9FA;
        --nuam-border: #DEE2E6;
    }
    
    .page-header {
        background: linear-gradient(135deg, var(--nuam-navy) 0%, #003d70 100%);
        color: white;
        padding: 2rem;
        border-radius: 8px;
        margin-bottom: 2rem;
        box-shadow: 0 2px 8px rgba(0, 42, 78, 0.15);
    }
    
    .section-card {
        background: white;
        border: 1px solid var(--nuam-border);
        border-radius: 8px;
        margin-bottom: 1.5rem;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        overflow: hidden;
    }
    
    .section-header {
        background: var(--nuam-light-gray);
        border-bottom: 3px solid var(--nuam-orange);
        padding: 1rem 1.5rem;
    }
    
    .section-header h5 {
        margin: 0;
        color: var(--nuam-navy);
        font-weight: 600;
        font-size: 1.1rem;
    }
    
    .section-header .section-number {
        display: inline-block;
        background: var(--nuam-orange);
        color: white;
        width: 32px;
        height: 32px;
        line-height: 32px;
        text-align: center;
        border-radius: 50%;
        margin-right: 0.75rem;
        font-weight: 700;
    }
    
    .section-body {
        padding: 1.5rem;
    }
    
    .btn-nuam {
        background: var(--nuam-orange);
        border: none;
        color: white;
        padding: 0.625rem 1.5rem;
        font-weight: 500;
        border-radius: 6px;
        transition: all 0.3s ease;
    }
    
    .btn-nuam:hover {
        background: #d96419;
        color: white;
        transform: translateY(-1px);
        box-shadow: 0 4px 8px rgba(243, 112, 33, 0.3);
    }
    
    .btn-nuam:active {
        transform: translateY(0);
    }
    
    .form-label {
        font-weight: 500;
        color: #495057;
        margin-bottom: 0.5rem;
    }
    
    .form-label.required::after {
        content: " *";
        color: #dc3545;
    }
    
    .form-control:focus,
    .form-select:focus {
        border-color: var(--nuam-orange);
        box-shadow: 0 0 0 0.2rem rgba(243, 112, 33, 0.25);
    }
    
    .toggle-buttons {
        display: flex;
        gap: 1rem;
        margin-bottom: 1.5rem;
    }
    
    .toggle-buttons .btn-check:checked + .btn {
        background: var(--nuam-orange);
        border-color: var(--nuam-orange);
        color: white;
    }
    
    .calculator-panel {
        background: #f8f9fa;
        border: 2px dashed #dee2e6;
        border-radius: 8px;
        padding: 1.5rem;
        margin-top: 1rem;
    }
    
    .calculator-panel.hidden {
        display: none;
    }
    
    .monto-input-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
        gap: 1rem;
        margin-bottom: 1.5rem;
    }
    
    .monto-input-item label {
        font-size: 0.875rem;
        font-weight: 500;
        color: #6c757d;
        margin-bottom: 0.25rem;
    }
    
    .factor-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
        gap: 1rem;
    }
    
    .factor-item {
        position: relative;
    }
    
    .factor-item label {
        font-size: 0.875rem;
        font-weight: 500;
        margin-bottom: 0.25rem;
        color: #495057;
    }
    
    .factor-item input {
        font-family: 'Courier New', monospace;
        font-size: 0.9rem;
    }
    
    .critical-factors {
        background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
        border: 2px solid #2196f3;
        border-radius: 8px;
        padding: 1.5rem;
        margin-bottom: 1.5rem;
    }
    
    .critical-factors h6 {
        color: #1565c0;
        font-weight: 600;
        margin-bottom: 1rem;
    }
    
    .secondary-factors {
        padding: 1.5rem;
        background: #fafafa;
        border-radius: 8px;
    }
    
    .validation-warning {
        background: #fff3cd;
        border: 2px solid #ffc107;
        border-radius: 6px;
        padding: 1rem;
        margin-bottom: 1.5rem;
    }
    
    .validation-warning i {
        color: #ff9800;
    }
    
    .suma-display {
        display: inline-block;
        background: white;
        border: 2px solid #dee2e6;
        padding: 0.5rem 1rem;
        border-radius: 6px;
        font-family: 'Courier New', monospace;
        font-weight: 600;
        font-size: 1.1rem;
    }
    
    .suma-display.valid {
        border-color: #28a745;
        color: #28a745;
    }
    
    .suma-display.invalid {
        border-color: #dc3545;
        color: #dc3545;
        animation: pulse 1s infinite;
    }
    
    @keyframes pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.7; }
    }
    
    .alert-nuam {
        background: #fff3e0;
        border-left: 4px solid var(--nuam-orange);
        color: #e65100;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid px-4 py-3">
    
    <!-- ========================================
         PAGE HEADER
         ======================================== -->
    <div class="page-header">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <h2 class="mb-2">
                    <i class="fas fa-file-invoice me-2"></i>
                    {{ form.instance.pk|yesno:"Editar,Nueva" }} Calificaci√≥n Tributaria
                </h2>
                <p class="mb-0 opacity-75">
                    Complete los datos requeridos para registrar la calificaci√≥n seg√∫n DJ 1949 o 1922.
                </p>
            </div>
            <a href="{% url 'listar_calificaciones' %}" class="btn btn-light">
                <i class="fas fa-arrow-left me-2"></i>Volver al Listado
            </a>
        </div>
    </div>
    
    <!-- Form Errors -->
    {% if form.errors %}
    <div class="alert alert-danger alert-dismissible fade show" role="alert">
        <h6 class="mb-2">
            <i class="fas fa-exclamation-triangle me-2"></i>
            <strong>Errores de Validaci√≥n:</strong>
        </h6>
        <ul class="mb-0">
            {% for field, errors in form.errors.items %}
                {% for error in errors %}
                    <li>{{ field|title }}: {{ error }}</li>
                {% endfor %}
            {% endfor %}
        </ul>
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
    {% endif %}
    
    <!-- Form -->
    <form method="post" id="formCalificacion" novalidate>
        {% csrf_token %}
        
        <!-- ========================================
             SECCI√ìN A: DATOS ADMINISTRATIVOS
             ======================================== -->
        <div class="section-card">
            <div class="section-header">
                <h5>
                    <span class="section-number">1</span>
                    <i class="fas fa-building me-2"></i>
                    Identificaci√≥n del Evento
                </h5>
            </div>
            <div class="section-body">
                <div class="row g-3">
                    <!-- Instrumento -->
                    <div class="col-md-4">
                        <label for="{{ form.instrumento.id_for_label }}" class="form-label required">
                            {{ form.instrumento.label }}
                        </label>
                        {{ form.instrumento }}
                        {% if form.instrumento.errors %}
                            <div class="text-danger small mt-1">{{ form.instrumento.errors.0 }}</div>
                        {% endif %}
                    </div>
                    
                    <!-- Fecha Informe -->
                    <div class="col-md-4">
                        <label for="{{ form.fecha_informe.id_for_label }}" class="form-label required">
                            {{ form.fecha_informe.label }}
                        </label>
                        {{ form.fecha_informe }}
                    </div>
                    
                    <!-- Mercado -->
                    <div class="col-md-4">
                        <label for="{{ form.mercado.id_for_label }}" class="form-label required">
                            {{ form.mercado.label }}
                        </label>
                        {{ form.mercado }}
                    </div>
                    
                    <!-- Secuencia -->
                    <div class="col-md-4">
                        <label for="{{ form.secuencia.id_for_label }}" class="form-label required">
                            {{ form.secuencia.label }}
                        </label>
                        {{ form.secuencia }}
                    </div>
                    
                    <!-- N√∫mero Dividendo -->
                    <div class="col-md-4">
                        <label for="{{ form.numero_dividendo.id_for_label }}" class="form-label">
                            {{ form.numero_dividendo.label }}
                        </label>
                        {{ form.numero_dividendo }}
                    </div>
                    
                    <!-- Tipo Sociedad -->
                    <div class="col-md-4">
                        <label for="{{ form.tipo_sociedad.id_for_label }}" class="form-label">
                            {{ form.tipo_sociedad.label }}
                        </label>
                        {{ form.tipo_sociedad }}
                    </div>
                    
                    <!-- Valor Hist√≥rico -->
                    <div class="col-md-4">
                        <label for="{{ form.valor_historico.id_for_label }}" class="form-label">
                            {{ form.valor_historico.label }}
                        </label>
                        {{ form.valor_historico }}
                    </div>
                    
                    <!-- N√∫mero DJ -->
                    <div class="col-md-4">
                        <label for="{{ form.numero_dj.id_for_label }}" class="form-label">
                            {{ form.numero_dj.label }}
                            <i class="fas fa-magic text-primary ms-1" title="Selecci√≥n autom√°tica seg√∫n tipo de instrumento"></i>
                        </label>
                        {{ form.numero_dj }}
                        <small class="form-text text-muted">
                            <i class="fas fa-info-circle"></i> Se asigna autom√°ticamente seg√∫n el instrumento
                        </small>
                    </div>
                    
                    <!-- Ejercicio -->
                    <div class="col-md-4">
                        <label for="{{ form.ejercicio.id_for_label }}" class="form-label">
                            {{ form.ejercicio.label }}
                        </label>
                        {{ form.ejercicio }}
                    </div>
                    
                    <!-- Observaciones -->
                    <div class="col-12">
                        <label for="{{ form.observaciones.id_for_label }}" class="form-label">
                            {{ form.observaciones.label }}
                        </label>
                        {{ form.observaciones }}
                        <small class="form-text text-muted">Comentarios adicionales sobre la calificaci√≥n</small>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- ========================================
             SECCI√ìN B: CALCULADORA
             ======================================== -->
        <div class="section-card">
            <div class="section-header">
                <h5>
                    <span class="section-number">2</span>
                    <i class="fas fa-calculator me-2"></i>
                    Definici√≥n de Valores
                </h5>
            </div>
            <div class="section-body">
                
                <!-- Toggle: Modo Ingreso -->
                <div class="alert alert-nuam">
                    <i class="fas fa-info-circle me-2"></i>
                    <strong>Seleccione el m√©todo de ingreso:</strong> Puede calcular factores autom√°ticamente desde montos o ingresarlos manualmente.
                </div>
                
                <div class="toggle-buttons">
                    <input type="radio" class="btn-check" name="modo_ingreso" id="modo_monto" value="monto" autocomplete="off" checked>
                    <label class="btn btn-outline-primary" for="modo_monto">
                        <i class="fas fa-dollar-sign me-2"></i>
                        Ingreso por Monto
                    </label>
                    
                    <input type="radio" class="btn-check" name="modo_ingreso" id="modo_factor" value="factor" autocomplete="off">
                    <label class="btn btn-outline-primary" for="modo_factor">
                        <i class="fas fa-percent me-2"></i>
                        Ingreso por Factor
                    </label>
                </div>
                
                <!-- Calculadora de Montos -->
                <div id="calculadora-panel" class="calculator-panel">
                    <h6 class="mb-3">
                        <i class="fas fa-coins me-2 text-warning"></i>
                        Ingreso de Montos para C√°lculo Autom√°tico
                    </h6>
                    <p class="text-muted small mb-3">
                        Ingrese los montos correspondientes a cada factor. El sistema calcular√° autom√°ticamente los factores proporcionales.
                    </p>
                    
                    <!-- Grid de inputs de montos (generados din√°micamente) -->
                    <div class="monto-input-grid" id="montos-container">
                        <!-- JavaScript generar√° los 30 inputs aqu√≠ -->
                    </div>
                    
                    <!-- Botones de Acci√≥n -->
                    <div class="d-flex justify-content-end gap-2">
                        <button type="button" id="btn-limpiar-montos" class="btn btn-outline-secondary">
                            <i class="fas fa-eraser me-2"></i>Limpiar Montos
                        </button>
                        <button type="button" id="btn-calcular" class="btn btn-nuam">
                            <i class="fas fa-calculator me-2"></i>
                            <span id="btn-calcular-text">Calcular Factores</span>
                            <span id="btn-calcular-spinner" class="spinner-border spinner-border-sm ms-2 d-none"></span>
                        </button>
                    </div>
                </div>
                
            </div>
        </div>
        
        <!-- ========================================
             SECCI√ìN C: GRILLA DE FACTORES
             ======================================== -->
        <div class="section-card">
            <div class="section-header">
                <h5>
                    <span class="section-number">3</span>
                    <i class="fas fa-chart-line me-2"></i>
                    Detalle de Factores (DJ 1949)
                </h5>
            </div>
            <div class="section-body">
                
                <!-- Warning: Validaci√≥n -->
                <div class="validation-warning">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            <strong>REGLA B de Validaci√≥n:</strong> La suma de factores 8-16 no debe superar 1.0
                        </div>
                        <div class="suma-display" id="suma-criticos">
                            0.00000000
                        </div>
                    </div>
                </div>
                
                <!-- FACTORES CR√çTICOS (8-16) -->
                <div class="critical-factors">
                    <h6>
                        <i class="fas fa-exclamation-circle me-2"></i>
                        Factores Cr√≠ticos (8-16)
                    </h6>
                    <div class="factor-grid">
                        <div class="factor-item">
                            <label for="id_factor_8" class="form-label">Factor 8</label>
                            {{ form.factor_8 }}
                        </div>
                        <div class="factor-item">
                            <label for="id_factor_9" class="form-label">Factor 9</label>
                            {{ form.factor_9 }}
                        </div>
                        <div class="factor-item">
                            <label for="id_factor_10" class="form-label">Factor 10</label>
                            {{ form.factor_10 }}
                        </div>
                        <div class="factor-item">
                            <label for="id_factor_11" class="form-label">Factor 11</label>
                            {{ form.factor_11 }}
                        </div>
                        <div class="factor-item">
                            <label for="id_factor_12" class="form-label">Factor 12</label>
                            {{ form.factor_12 }}
                        </div>
                        <div class="factor-item">
                            <label for="id_factor_13" class="form-label">Factor 13</label>
                            {{ form.factor_13 }}
                        </div>
                        <div class="factor-item">
                            <label for="id_factor_14" class="form-label">Factor 14</label>
                            {{ form.factor_14 }}
                        </div>
                        <div class="factor-item">
                            <label for="id_factor_15" class="form-label">Factor 15</label>
                            {{ form.factor_15 }}
                        </div>
                        <div class="factor-item">
                            <label for="id_factor_16" class="form-label">Factor 16</label>
                            {{ form.factor_16 }}
                        </div>
                    </div>
                </div>
                
                <!-- FACTORES SECUNDARIOS (17-37) -->
                <div class="secondary-factors">
                    <h6 class="mb-3" style="color: #6c757d;">
                        <i class="fas fa-layer-group me-2"></i>
                        Factores Secundarios (17-37)
                    </h6>
                    <div class="factor-grid">
                        <div class="factor-item">
                            <label for="id_factor_17" class="form-label">Factor 17</label>
                            {{ form.factor_17 }}
                        </div>
                        <div class="factor-item">
                            <label for="id_factor_18" class="form-label">Factor 18</label>
                            {{ form.factor_18 }}
                        </div>
                        <div class="factor-item">
                            <label for="id_factor_19" class="form-label">Factor 19</label>
                            {{ form.factor_19 }}
                        </div>
                        <div class="factor-item">
                            <label for="id_factor_20" class="form-label">Factor 20</label>
                            {{ form.factor_20 }}
                        </div>
                        <div class="factor-item">
                            <label for="id_factor_21" class="form-label">Factor 21</label>
                            {{ form.factor_21 }}
                        </div>
                        <div class="factor-item">
                            <label for="id_factor_22" class="form-label">Factor 22</label>
                            {{ form.factor_22 }}
                        </div>
                        <div class="factor-item">
                            <label for="id_factor_23" class="form-label">Factor 23</label>
                            {{ form.factor_23 }}
                        </div>
                        <div class="factor-item">
                            <label for="id_factor_24" class="form-label">Factor 24</label>
                            {{ form.factor_24 }}
                        </div>
                        <div class="factor-item">
                            <label for="id_factor_25" class="form-label">Factor 25</label>
                            {{ form.factor_25 }}
                        </div>
                        <div class="factor-item">
                            <label for="id_factor_26" class="form-label">Factor 26</label>
                            {{ form.factor_26 }}
                        </div>
                        <div class="factor-item">
                            <label for="id_factor_27" class="form-label">Factor 27</label>
                            {{ form.factor_27 }}
                        </div>
                        <div class="factor-item">
                            <label for="id_factor_28" class="form-label">Factor 28</label>
                            {{ form.factor_28 }}
                        </div>
                        <div class="factor-item">
                            <label for="id_factor_29" class="form-label">Factor 29</label>
                            {{ form.factor_29 }}
                        </div>
                        <div class="factor-item">
                            <label for="id_factor_30" class="form-label">Factor 30</label>
                            {{ form.factor_30 }}
                        </div>
                        <div class="factor-item">
                            <label for="id_factor_31" class="form-label">Factor 31</label>
                            {{ form.factor_31 }}
                        </div>
                        <div class="factor-item">
                            <label for="id_factor_32" class="form-label">Factor 32</label>
                            {{ form.factor_32 }}
                        </div>
                        <div class="factor-item">
                            <label for="id_factor_33" class="form-label">Factor 33</label>
                            {{ form.factor_33 }}
                        </div>
                        <div class="factor-item">
                            <label for="id_factor_34" class="form-label">Factor 34</label>
                            {{ form.factor_34 }}
                        </div>
                        <div class="factor-item">
                            <label for="id_factor_35" class="form-label">Factor 35</label>
                            {{ form.factor_35 }}
                        </div>
                        <div class="factor-item">
                            <label for="id_factor_36" class="form-label">Factor 36</label>
                            {{ form.factor_36 }}
                        </div>
                        <div class="factor-item">
                            <label for="id_factor_37" class="form-label">Factor 37</label>
                            {{ form.factor_37 }}
                        </div>
                    </div>
                </div>
                
            </div>
        </div>
        
        <!-- ========================================
             SECCI√ìN D: ESTADO Y ACCIONES
             ======================================== -->
        <div class="section-card">
            <div class="section-header">
                <h5>
                    <span class="section-number">4</span>
                    <i class="fas fa-toggle-on me-2"></i>
                    Estado y Guardar
                </h5>
            </div>
            <div class="section-body">
                <div class="row g-3">
                    <!-- Estado Activo -->
                    <div class="col-12">
                        <div class="form-check form-switch">
                            {{ form.activo }}
                            <label class="form-check-label" for="{{ form.activo.id_for_label }}">
                                <i class="fas fa-check-circle me-2 text-success"></i>
                                {{ form.activo.label }}
                            </label>
                            <small class="form-text text-muted d-block mt-1">
                                Marque esta opci√≥n si desea que la calificaci√≥n est√© activa en el sistema
                            </small>
                        </div>
                    </div>
                    
                    <!-- Botones de Acci√≥n -->
                    <div class="col-12 mt-4">
                        <div class="d-flex gap-2">
                            <button type="submit" class="btn btn-nuam btn-lg px-5">
                                <i class="fas fa-save me-2"></i>Guardar Calificaci√≥n
                            </button>
                            <a href="{% url 'listar_calificaciones' %}" class="btn btn-outline-secondary btn-lg">
                                <i class="fas fa-times me-2"></i>Cancelar
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
    </form>
    
</div>
{% endblock %}

{% block extra_js %}
<script>
    // ========================================
    // CONFIGURACI√ìN
    // ========================================
    const AJAX_URL = "{% url 'calcular_factores_ajax' %}";
    const CSRF_TOKEN = "{{ csrf_token }}";
    const TOTAL_FACTORES = 30;
    
    // Mapa de instrumentos para autoselecci√≥n de DJ
    const INSTRUMENTOS_MAP = {{ instrumentos_map_json|safe }};
    
    document.addEventListener('DOMContentLoaded', function() {
        console.log('üöÄ Inicializando formulario de calificaci√≥n...');
        
        // ========================================
        // 1. AUTOSELECCI√ìN DE DJ BASADO EN INSTRUMENTO
        // ========================================
        const instrumentoSelect = document.getElementById('id_instrumento');
        const numeroDjInput = document.getElementById('id_numero_dj');
        
        if (instrumentoSelect && numeroDjInput) {
            instrumentoSelect.addEventListener('change', function() {
                const instrumentoId = this.value;
                
                if (instrumentoId && INSTRUMENTOS_MAP[instrumentoId]) {
                    const djRecomendado = INSTRUMENTOS_MAP[instrumentoId].dj;
                    const tipoInstrumento = INSTRUMENTOS_MAP[instrumentoId].tipo;
                    
                    // Actualizar campo DJ autom√°ticamente
                    numeroDjInput.value = djRecomendado;
                    
                    // Feedback visual
                    numeroDjInput.style.background = '#e7f3ff';
                    numeroDjInput.style.borderColor = '#2196f3';
                    
                    console.log(`‚úÖ DJ ${djRecomendado} asignado autom√°ticamente (Instrumento: ${tipoInstrumento})`);
                    
                    // Mostrar notificaci√≥n
                    mostrarNotificacion(
                        `DJ ${djRecomendado} seleccionado autom√°ticamente para ${tipoInstrumento}`,
                        'info'
                    );
                    
                    // Restaurar estilo despu√©s de 2 segundos
                    setTimeout(() => {
                        numeroDjInput.style.background = '';
                        numeroDjInput.style.borderColor = '';
                    }, 2000);
                } else if (!instrumentoId) {
                    // Limpiar si no hay instrumento seleccionado
                    numeroDjInput.value = '';
                }
            });
            
            // Aplicar autom√°ticamente si ya hay un instrumento seleccionado (edici√≥n)
            if (instrumentoSelect.value) {
                const event = new Event('change');
                instrumentoSelect.dispatchEvent(event);
            }
        }
        
        // ========================================
        // 2. TOGGLE MODO MONTO/FACTOR
        // ========================================
        const modoMonto = document.getElementById('modo_monto');
        const modoFactor = document.getElementById('modo_factor');
        const calculadoraPanel = document.getElementById('calculadora-panel');
        
        function toggleModo() {
            const esModoMonto = modoMonto.checked;
            
            if (esModoMonto) {
                calculadoraPanel.classList.remove('hidden');
                // En modo monto, los factores se calculan autom√°ticamente
                for (let i = 8; i <= 37; i++) {
                    const factorInput = document.getElementById(`id_factor_${i}`);
                    if (factorInput) {
                        factorInput.readOnly = true;
                        factorInput.style.background = '#e9ecef';
                    }
                }
            } else {
                calculadoraPanel.classList.add('hidden');
                // En modo factor, se pueden editar manualmente
                for (let i = 8; i <= 37; i++) {
                    const factorInput = document.getElementById(`id_factor_${i}`);
                    if (factorInput) {
                        factorInput.readOnly = false;
                        factorInput.style.background = 'white';
                    }
                }
            }
        }
        
        modoMonto.addEventListener('change', toggleModo);
        modoFactor.addEventListener('change', toggleModo);
        toggleModo(); // Inicializar
        
        // ========================================
        // 2. GENERAR INPUTS DE MONTOS
        // ========================================
        const montosContainer = document.getElementById('montos-container');
        
        for (let i = 8; i <= 37; i++) {
            const div = document.createElement('div');
            div.className = 'monto-input-item';
            div.innerHTML = `
                <label for="monto_${i}">Monto ${i}</label>
                <input type="number" 
                       id="monto_${i}" 
                       class="form-control monto-input" 
                       step="0.01" 
                       min="0"
                       placeholder="0.00">
            `;
            montosContainer.appendChild(div);
        }
        
        // ========================================
        // 3. CALCULAR FACTORES (AJAX)
        // ========================================
        const btnCalcular = document.getElementById('btn-calcular');
        const btnTexto = document.getElementById('btn-calcular-text');
        const btnSpinner = document.getElementById('btn-calcular-spinner');
        
        btnCalcular.addEventListener('click', async function() {
            console.log('üßÆ Calculando factores...');
            
            // UI: Mostrar loading
            btnCalcular.disabled = true;
            btnTexto.textContent = 'Calculando...';
            btnSpinner.classList.remove('d-none');
            
            // Recopilar montos
            const formData = new FormData();
            for (let i = 8; i <= 37; i++) {
                const montoInput = document.getElementById(`monto_${i}`);
                formData.append(`monto_${i}`, montoInput.value || '0');
            }
            
            try {
                const response = await fetch(AJAX_URL, {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': CSRF_TOKEN
                    },
                    body: formData
                });
                
                const data = await response.json();
                
                if (data.success) {
                    console.log('‚úÖ Factores calculados:', data);
                    
                    // Poblar factores
                    for (let i = 8; i <= 37; i++) {
                        const factorInput = document.getElementById(`id_factor_${i}`);
                        if (factorInput && data.factores[`factor_${i}`]) {
                            factorInput.value = data.factores[`factor_${i}`];
                        }
                    }
                    
                    // Actualizar suma de cr√≠ticos
                    actualizarSumaCriticos();
                    
                    // Mensaje de √©xito
                    mostrarNotificacion('Factores calculados correctamente', 'success');
                } else {
                    console.error('‚ùå Error en c√°lculo:', data.error);
                    mostrarNotificacion(data.error, 'error');
                }
                
            } catch (error) {
                console.error('‚ùå Error de red:', error);
                mostrarNotificacion('Error al comunicarse con el servidor', 'error');
            } finally {
                // Restaurar bot√≥n
                btnCalcular.disabled = false;
                btnTexto.textContent = 'Calcular Factores';
                btnSpinner.classList.add('d-none');
            }
        });
        
        // ========================================
        // 4. LIMPIAR MONTOS
        // ========================================
        const btnLimpiar = document.getElementById('btn-limpiar-montos');
        btnLimpiar.addEventListener('click', function() {
            for (let i = 8; i <= 37; i++) {
                const montoInput = document.getElementById(`monto_${i}`);
                if (montoInput) montoInput.value = '';
                
                const factorInput = document.getElementById(`id_factor_${i}`);
                if (factorInput) factorInput.value = '';
            }
            actualizarSumaCriticos();
            mostrarNotificacion('Montos y factores limpiados', 'info');
        });
        
        // ========================================
        // 5. SUMA DE FACTORES CR√çTICOS EN TIEMPO REAL
        // ========================================
        function actualizarSumaCriticos() {
            let suma = 0;
            for (let i = 8; i <= 16; i++) {
                const factorInput = document.getElementById(`id_factor_${i}`);
                if (factorInput && factorInput.value) {
                    suma += parseFloat(factorInput.value) || 0;
                }
            }
            
            const sumaDisplay = document.getElementById('suma-criticos');
            sumaDisplay.textContent = suma.toFixed(8);
            
            // Validaci√≥n visual
            if (suma > 1.0) {
                sumaDisplay.classList.add('invalid');
                sumaDisplay.classList.remove('valid');
            } else {
                sumaDisplay.classList.add('valid');
                sumaDisplay.classList.remove('invalid');
            }
        }
        
        // Escuchar cambios en factores cr√≠ticos
        for (let i = 8; i <= 16; i++) {
            const factorInput = document.getElementById(`id_factor_${i}`);
            if (factorInput) {
                factorInput.addEventListener('input', actualizarSumaCriticos);
            }
        }
        
        // Inicializar suma
        actualizarSumaCriticos();
        
        // ========================================
        // 6. VALIDACI√ìN PRE-SUBMIT
        // ========================================
        const form = document.getElementById('formCalificacion');
        form.addEventListener('submit', function(e) {
            // Verificar REGLA B
            let sumaCriticos = 0;
            for (let i = 8; i <= 16; i++) {
                const factorInput = document.getElementById(`id_factor_${i}`);
                sumaCriticos += parseFloat(factorInput.value) || 0;
            }
            
            if (sumaCriticos > 1.0) {
                e.preventDefault();
                mostrarNotificacion(
                    `REGLA B violada: La suma de factores 8-16 es ${sumaCriticos.toFixed(8)}, debe ser ‚â§ 1.0`,
                    'error'
                );
                return false;
            }
            
            console.log('‚úÖ Validaci√≥n pasada, enviando formulario...');
        });
        
        // ========================================
        // HELPERS
        // ========================================
        function mostrarNotificacion(mensaje, tipo) {
            const colores = {
                success: '#28a745',
                error: '#dc3545',
                info: '#17a2b8'
            };
            
            const iconos = {
                success: 'fa-check-circle',
                error: 'fa-exclamation-circle',
                info: 'fa-info-circle'
            };
            
            const notif = document.createElement('div');
            notif.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: white;
                color: ${colores[tipo]};
                padding: 1rem 1.5rem;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                border-left: 4px solid ${colores[tipo]};
                z-index: 9999;
                animation: slideIn 0.3s ease;
                max-width: 400px;
            `;
            notif.innerHTML = `<i class="fas ${iconos[tipo]} me-2"></i>${mensaje}`;
            document.body.appendChild(notif);
            
            setTimeout(() => {
                notif.style.animation = 'slideOut 0.3s ease';
                setTimeout(() => notif.remove(), 300);
            }, 3000);
        }
        
        console.log('‚úÖ Formulario inicializado correctamente');
    });
</script>

<style>
    @keyframes slideIn {
        from { transform: translateX(400px); opacity: 0; }
        to { transform: translateX(0); opacity: 1; }
    }
    
    @keyframes slideOut {
        from { transform: translateX(0); opacity: 1; }
        to { transform: translateX(400px); opacity: 0; }
    }
</style>
{% endblock %}
