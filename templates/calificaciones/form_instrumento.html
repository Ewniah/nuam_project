{% extends 'base.html' %}

{% block title %}{% if form.instance.pk %}Editar{% else %}Nuevo{% endif %} Instrumento - NUAM{% endblock %}
{% block navbar_section %}Instrumentos{% endblock %}

{% block content %}
<div class="container-fluid px-4">
    <!-- Page Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2 class="fw-bold mb-1" style="color: #002A4E;">
                <i class="fas fa-{% if form.instance.pk %}edit{% else %}plus{% endif %} me-2" style="color: #F37021;"></i>
                {% if form.instance.pk %}Editar{% else %}Nuevo{% endif %} Instrumento
            </h2>
            <p class="text-muted mb-0">{% if form.instance.pk %}Modificar datos del instrumento financiero{% else %}Agregar nuevo instrumento al cat√°logo{% endif %}</p>
        </div>
        <a href="{% url 'listar_instrumentos' %}" class="btn btn-outline-secondary btn-sm">
            <i class="fas fa-arrow-left me-2"></i>Volver
        </a>
    </div>

    <div class="row justify-content-center">
        <div class="col-md-8">
            <div class="card shadow-sm border-0">
                <div class="card-header bg-white border-bottom">
                    <h5 class="mb-0 fw-semibold" style="color: #002A4E;">
                        <i class="fas fa-file-alt me-2" style="color: #F37021;"></i>Datos del Instrumento
                    </h5>
                </div>
            <div class="card-body p-4">
                <form method="post">
                    {% csrf_token %}

                    {% if form.non_field_errors %}
                    <div class="alert alert-danger shadow-sm border-0">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        {{ form.non_field_errors }}
                    </div>
                    {% endif %}

                    <!-- C√≥digo del Instrumento -->
                    <div class="mb-3">
                        <label for="{{ form.codigo_instrumento.id_for_label }}"
                            class="form-label fw-semibold" style="color: #002A4E;">
                            C√ìDIGO DEL INSTRUMENTO <span class="text-muted small">(opcional)</span>
                        </label>
                        {{ form.codigo_instrumento }}
                        {% if form.codigo_instrumento.errors %}
                        <div class="text-danger mt-1 small">{{ form.codigo_instrumento.errors }}</div>
                        {% endif %}
                        <div class="form-text small text-muted">
                            <i class="fas fa-magic" style="color: #F37021;"></i> 
                            Si se deja vac√≠o, se generar√° autom√°ticamente basado en el nombre (ej: "Empresas CMPC" ‚Üí "ECMPC")
                        </div>
                    </div>

                    <!-- Nombre del Instrumento -->
                    <div class="mb-3">
                        <label for="{{ form.nombre_instrumento.id_for_label }}"
                            class="form-label fw-semibold" style="color: #002A4E;">
                            NOMBRE DEL INSTRUMENTO *
                        </label>
                        {{ form.nombre_instrumento }}
                        {% if form.nombre_instrumento.errors %}
                        <div class="text-danger mt-1 small">{{ form.nombre_instrumento.errors }}</div>
                        {% endif %}
                        <div class="form-text small text-muted">Nombre completo del instrumento financiero</div>
                    </div>

                    <!-- Tipo de Instrumento -->
                    <div class="mb-3">
                        <label for="{{ form.tipo_instrumento.id_for_label }}"
                            class="form-label fw-semibold" style="color: #002A4E;">
                            TIPO DE INSTRUMENTO *
                        </label>
                        {{ form.tipo_instrumento }}
                        {% if form.tipo_instrumento.errors %}
                        <div class="text-danger mt-1 small">{{ form.tipo_instrumento.errors }}</div>
                        {% endif %}
                        <div class="form-text small text-muted">Categor√≠a del instrumento (Acci√≥n, Bono, Fondo Mutuo, etc.)</div>
                    </div>

                    <!-- Estado Activo -->
                    <div class="mb-3">
                        <div class="form-check form-switch">
                            {{ form.activo }}
                            <label class="form-check-label fw-semibold" for="{{ form.activo.id_for_label }}" style="color: #002A4E;">
                                Instrumento Activo
                            </label>
                        </div>
                        <div class="form-text small text-muted">Desactive si el instrumento ya no est√° disponible</div>
                    </div>

                    <!-- Botones de Acci√≥n -->
                    <hr class="my-4">
                    <div class="d-flex justify-content-end gap-3">
                        <a href="{% url 'listar_instrumentos' %}" class="btn btn-outline-secondary">
                            <i class="fas fa-times me-2"></i>Cancelar
                        </a>
                        <button type="submit" class="btn px-4" style="background-color: #F37021; color: white;">
                            <i class="fas fa-save me-2"></i>Guardar Instrumento
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
</div>

<script>
// ========================================
// SMART AUTOMATION FOR INSTRUMENT FORM
// ========================================

document.addEventListener('DOMContentLoaded', function() {
    const codigoInput = document.getElementById('{{ form.codigo_instrumento.id_for_label }}');
    const nombreInput = document.getElementById('{{ form.nombre_instrumento.id_for_label }}');
    const tipoInput = document.getElementById('{{ form.tipo_instrumento.id_for_label }}');
    
    // ========================================
    // 1. AUTO-UPPERCASE PARA C√ìDIGO
    // ========================================
    codigoInput.addEventListener('input', function() {
        const cursorPos = this.selectionStart;
        this.value = this.value.toUpperCase();
        this.setSelectionRange(cursorPos, cursorPos);
    });
    
    // ========================================
    // 2. SUGERENCIA INTELIGENTE DE C√ìDIGO
    // ========================================
    let codigoSugerido = false;
    
    nombreInput.addEventListener('input', function() {
        const nombre = this.value.trim();
        
        // Solo sugerir si el c√≥digo est√° vac√≠o y no ha sido editado manualmente
        if (!codigoSugerido && codigoInput.value.trim() === '' && nombre.length > 2) {
            // Extraer primera palabra significativa
            const palabras = nombre.toUpperCase().split(/\s+/);
            const palabrasSignificativas = palabras.filter(p => 
                !['DE', 'DEL', 'LA', 'LAS', 'LOS', 'EL', 'Y', 'E', 'O'].includes(p)
            );
            
            let sugerencia = '';
            if (palabrasSignificativas.length > 0) {
                // Usar primera palabra o iniciales
                if (palabrasSignificativas[0].length <= 5) {
                    sugerencia = palabrasSignificativas[0];
                } else {
                    // Crear acr√≥nimo con primeras letras
                    sugerencia = palabrasSignificativas.slice(0, 4)
                        .map(p => p[0])
                        .join('');
                }
            }
            
            if (sugerencia) {
                codigoInput.value = sugerencia.substring(0, 10);
                // Feedback visual
                codigoInput.style.transition = 'all 0.3s ease';
                codigoInput.style.borderColor = '#F37021';
                codigoInput.style.boxShadow = '0 0 0 0.2rem rgba(243, 112, 33, 0.25)';
                setTimeout(() => {
                    codigoInput.style.borderColor = '';
                    codigoInput.style.boxShadow = '';
                }, 1500);
            }
        }
        
        // ========================================
        // 3. AUTO-DETECCI√ìN DE TIPO (HEUR√çSTICA)
        // ========================================
        const nombreLower = nombre.toLowerCase();
        let tipoDetectado = '';
        let confianza = '';
        
        // REGLA 1: Fondos (alta prioridad)
        if (nombreLower.includes('fondo') || 
            nombreLower.includes('cfi') || 
            nombreLower.includes('fm') ||
            nombreLower.includes('mutuo')) {
            tipoDetectado = 'Fondo Mutuo';
            confianza = 'üéØ';
        }
        // REGLA 2: Bonos
        else if (nombreLower.includes('bono') || 
                 nombreLower.includes('deuda') ||
                 nombreLower.includes('obligaci√≥n')) {
            tipoDetectado = 'Bono';
            confianza = 'üéØ';
        }
        // REGLA 3: ETF
        else if (nombreLower.includes('etf') || 
                 nombreLower.includes('spdr') ||
                 nombreLower.includes('ishares')) {
            tipoDetectado = 'ETF';
            confianza = 'üéØ';
        }
        // REGLA 4: Acciones (empresas t√≠picas)
        else if (nombreLower.includes('banco') || 
                 nombreLower.includes('s.a.') || 
                 nombreLower.includes('sa ') ||
                 nombreLower.includes('enel') || 
                 nombreLower.includes('copec') ||
                 nombreLower.includes('cmpc') ||
                 nombreLower.includes('entel') ||
                 nombreLower.includes('cencosud') ||
                 nombreLower.includes('falabella') ||
                 nombreLower.includes('sqm') ||
                 nombreLower.includes('colb√∫n') ||
                 nombreLower.includes('security') ||
                 nombreLower.includes('empresas ')) {
            tipoDetectado = 'Acci√≥n';
            confianza = 'üéØ';
        }
        
        // Aplicar sugerencia si se detect√≥ algo
        if (tipoDetectado && tipoInput.value.trim() === '') {
            tipoInput.value = tipoDetectado;
            
            // Feedback visual mejorado
            tipoInput.style.transition = 'all 0.4s ease';
            tipoInput.style.borderColor = '#F37021';
            tipoInput.style.backgroundColor = '#fff5f0';
            tipoInput.style.boxShadow = '0 0 0 0.25rem rgba(243, 112, 33, 0.25)';
            
            // Mostrar notificaci√≥n sutil
            const notif = document.createElement('div');
            notif.className = 'alert alert-info alert-dismissible fade show mt-2';
            notif.style.borderLeft = '4px solid #F37021';
            notif.innerHTML = `
                <i class="fas fa-robot me-2" style="color: #F37021;"></i>
                <strong>${confianza} Auto-detecci√≥n:</strong> Se sugiri√≥ "<strong>${tipoDetectado}</strong>" basado en el nombre
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            
            tipoInput.parentElement.appendChild(notif);
            
            // Remover notificaci√≥n despu√©s de 5 segundos
            setTimeout(() => {
                notif.remove();
                tipoInput.style.borderColor = '';
                tipoInput.style.backgroundColor = '';
                tipoInput.style.boxShadow = '';
            }, 5000);
        }
    });
    
    // Marcar que el c√≥digo fue editado manualmente
    codigoInput.addEventListener('keydown', function() {
        codigoSugerido = true;
    });
    
    // ========================================
    // 4. VALIDACI√ìN EN TIEMPO REAL
    // ========================================
    nombreInput.addEventListener('blur', function() {
        if (this.value.trim().length < 3) {
            this.style.borderColor = '#dc3545';
            this.nextElementSibling.textContent = 'El nombre debe tener al menos 3 caracteres';
            this.nextElementSibling.classList.add('text-danger');
        } else {
            this.style.borderColor = '';
            this.nextElementSibling.textContent = 'Nombre completo del instrumento financiero';
            this.nextElementSibling.classList.remove('text-danger');
        }
    });
    
    tipoInput.addEventListener('blur', function() {
        if (this.value.trim() === '') {
            this.style.borderColor = '#ffc107';
        } else {
            this.style.borderColor = '';
        }
    });
    
    // ========================================
    // 5. TIPS CONTEXTUALES
    // ========================================
    const tips = {
        'Acci√≥n': 'üíº Representa participaci√≥n en una empresa',
        'Bono': 'üìä Instrumento de deuda de renta fija',
        'Fondo Mutuo': 'üè¶ Cartera diversificada administrada profesionalmente',
        'ETF': 'üìà Fondo cotizado que replica √≠ndices'
    };
    
    tipoInput.addEventListener('change', function() {
        const tipText = tips[this.value];
        if (tipText) {
            const helpText = this.parentElement.querySelector('.form-text');
            helpText.innerHTML = `<i class="fas fa-lightbulb me-1" style="color: #F37021;"></i>${tipText}`;
        }
    });
    
    // ========================================
    // 6. TOOLTIPS INFORMATIVOS - COBERTURA 100%
    // ========================================
    const INSTRUMENT_FIELD_DESCRIPTIONS = {
        'codigo_instrumento': 'Nemo o Ticker de Bolsa (Ej: CHILE, COPEC, CMPC). <strong>Se convertir√° autom√°ticamente a may√∫sculas</strong>. Si se deja vac√≠o, se generar√° autom√°ticamente.',
        'nombre_instrumento': 'Nombre legal completo o fantas√≠a del instrumento financiero. Ej: "Banco de Chile", "Fondo Mutuo Renta Fija BCI". <strong>M√≠nimo 3 caracteres</strong>.',
        'tipo_instrumento': 'Clasificaci√≥n del activo financiero seg√∫n mercado:<br>‚Ä¢ <strong>Acci√≥n</strong>: Participaci√≥n en capital<br>‚Ä¢ <strong>Fondo Mutuo</strong>: Cartera diversificada<br>‚Ä¢ <strong>CFI</strong>: Cuota de Fondo de Inversi√≥n<br>‚Ä¢ <strong>Bono</strong>: Instrumento de deuda<br>‚Ä¢ <strong>ETF</strong>: Fondo cotizado en bolsa',
        'activo': 'Estado del instrumento en el sistema:<br>‚Ä¢ <strong>‚úì Activo</strong>: Disponible para nuevas calificaciones<br>‚Ä¢ <strong>‚úó Inactivo</strong>: No aparecer√° en selectores (hist√≥ricos se mantienen)'
    };
    
    // Agregar tooltips a todos los labels de campos
    Object.keys(INSTRUMENT_FIELD_DESCRIPTIONS).forEach(fieldId => {
        const label = document.querySelector(`label[for="id_${fieldId}"]`);
        if (label && !label.querySelector('.fa-question-circle')) {
            const helpIcon = document.createElement('i');
            helpIcon.className = 'fas fa-question-circle ms-2 text-muted';
            helpIcon.style.cursor = 'help';
            helpIcon.style.fontSize = '0.875rem';
            helpIcon.setAttribute('data-bs-toggle', 'tooltip');
            helpIcon.setAttribute('data-bs-placement', 'top');
            helpIcon.setAttribute('data-bs-html', 'true');
            helpIcon.setAttribute('title', `<small>${INSTRUMENT_FIELD_DESCRIPTIONS[fieldId]}</small>`);
            
            label.appendChild(helpIcon);
        }
    });
    
    // Inicializar tooltips de Bootstrap
    const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    const tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl, {
            boundary: 'window',
            customClass: 'tooltip-nuam'
        });
    });
    
    console.log(`‚ÑπÔ∏è ${tooltipTriggerList.length} tooltips de instrumentos inicializados`);
});
</script>

<style>
    /* Estilo personalizado para tooltips */
    .tooltip-nuam .tooltip-inner {
        background-color: #002A4E;
        color: white;
        text-align: left;
        max-width: 320px;
        padding: 0.75rem 1rem;
        font-size: 0.875rem;
        box-shadow: 0 4px 12px rgba(0, 42, 78, 0.3);
    }
    
    .tooltip-nuam .tooltip-arrow::before {
        border-top-color: #002A4E;
    }
    
    label i.fa-question-circle:hover {
        color: #F37021 !important;
        transform: scale(1.15);
        transition: all 0.2s ease;
    }
</style>

{% endblock %}