{% extends 'base.html' %}
{% load static %}
{% load humanize %}

{% block title %}Registro de Auditor칤a - NUAM{% endblock %}
{% block navbar_section %}Auditor칤a{% endblock %}

{% block content %}
<div class="container-fluid px-4">
    <!-- Page Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2 class="fw-bold mb-1" style="color: #002A4E;">
                <i class="fas fa-shield-alt me-2" style="color: #F37021;"></i>Registro de Auditor칤a
            </h2>
            <p class="text-muted mb-0">Monitoreo de acciones y eventos del sistema</p>
        </div>
        <span class="badge px-3 py-2" style="background-color: #002A4E; color: white;">
            <i class="fas fa-database me-2"></i>{{ logs|length }} registro{{ logs|length|pluralize:"s" }}
        </span>
    </div>

    <!-- Tabs de Categor칤as (Compactas) -->
    <ul class="nav nav-tabs mb-3" id="auditoriaTabs" role="tablist" style="font-size: 0.9rem;">
        <li class="nav-item" role="presentation">
            <button class="nav-link active fw-semibold py-2 px-3" id="todas-tab" data-bs-toggle="tab" data-bs-target="#todas" type="button" role="tab">
                <i class="fas fa-list me-1"></i>Todas
                <span class="badge rounded-pill ms-1" style="background-color: #002A4E; font-size: 0.7rem;">{{ logs|length }}</span>
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link fw-semibold py-2 px-3" id="crud-tab" data-bs-toggle="tab" data-bs-target="#crud" type="button" role="tab">
                <i class="fas fa-database me-1"></i>CRUD
                <span class="badge bg-primary rounded-pill ms-1" style="font-size: 0.7rem;">{{ logs_crud|length }}</span>
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link fw-semibold py-2 px-3" id="sesiones-tab" data-bs-toggle="tab" data-bs-target="#sesiones" type="button" role="tab">
                <i class="fas fa-sign-in-alt me-1"></i>Sesiones
                <span class="badge bg-success rounded-pill ms-1" style="font-size: 0.7rem;">{{ logs_sesiones|length }}</span>
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link fw-semibold py-2 px-3" id="cargas-tab" data-bs-toggle="tab" data-bs-target="#cargas" type="button" role="tab">
                <i class="fas fa-upload me-1"></i>Cargas
                <span class="badge rounded-pill ms-1" style="background-color: #F37021; font-size: 0.7rem;">{{ logs_cargas|length }}</span>
            </button>
        </li>
    </ul>

    <!-- Filtros Mejorados -->
    <div class="card shadow-sm border-0 mb-4" style="background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);">
        <div class="card-body p-4" style="min-height: 140px;">
            <form method="get" class="row g-3" id="filtrosForm">
                <input type="hidden" name="categoria" id="categoriaInput" value="{{ categoria }}">
                
                <!-- Usuario -->
                <div class="col-lg-3 col-md-4">
                    <label class="form-label small fw-semibold mb-2" style="color: #002A4E;">
                        <i class="fas fa-user me-1" style="color: #F37021;"></i>Filtrar por Usuario
                    </label>
                    <select name="usuario" class="form-select form-select-sm" style="border: 2px solid #dee2e6;">
                        <option value="">游논 Todos los usuarios</option>
                        {% for u in usuarios %}
                        <option value="{{ u.id }}" {% if usuario_filtro == u.id|stringformat:"s" %}selected{% endif %}>
                            {{ u.username }}{% if u.get_full_name %} ({{ u.get_full_name }}){% endif %}
                        </option>
                        {% endfor %}
                    </select>
                    <small class="form-text text-muted"><i class="fas fa-info-circle me-1"></i>Selecciona un usuario espec칤fico</small>
                </div>

                <!-- Fecha Desde -->
                <div class="col-lg-3 col-md-4">
                    <label class="form-label small fw-semibold mb-2" style="color: #002A4E;">
                        <i class="fas fa-calendar-alt me-1" style="color: #F37021;"></i>Desde
                    </label>
                    <input type="date" 
                           name="fecha_desde" 
                           class="form-control form-control-sm" 
                           style="border: 2px solid #dee2e6;"
                           value="{{ fecha_desde }}"
                           max="{{ fecha_hasta|default:'' }}">
                    <small class="form-text text-muted"><i class="fas fa-info-circle me-1"></i>Fecha inicial del rango</small>
                </div>

                <!-- Fecha Hasta -->
                <div class="col-lg-3 col-md-4">
                    <label class="form-label small fw-semibold mb-2" style="color: #002A4E;">
                        <i class="fas fa-calendar-check me-1" style="color: #F37021;"></i>Hasta
                    </label>
                    <input type="date" 
                           name="fecha_hasta" 
                           class="form-control form-control-sm" 
                           style="border: 2px solid #dee2e6;"
                           value="{{ fecha_hasta }}"
                           min="{{ fecha_desde|default:'' }}">
                    <small class="form-text text-muted"><i class="fas fa-info-circle me-1"></i>Fecha final del rango</small>
                </div>

                <!-- Botones de Acci칩n -->
                <div class="col-lg-3 col-md-12">
                    <label class="form-label small fw-semibold mb-2" style="color: #002A4E;">
                        <i class="fas fa-cog me-1" style="color: #F37021;"></i>Acciones
                    </label>
                    <div class="d-flex gap-2">
                        <button type="submit" class="btn btn-sm flex-fill shadow-sm" style="background-color: #F37021; color: white; font-weight: 600; border: 2px solid #F37021;">
                            <i class="fas fa-search me-2"></i>Buscar
                        </button>
                        <button type="button" class="btn btn-sm btn-outline-secondary shadow-sm" onclick="limpiarFiltros()" title="Limpiar todos los filtros" style="border: 2px solid #dee2e6;">
                            <i class="fas fa-eraser"></i>
                        </button>
                        <button type="button" class="btn btn-sm btn-outline-primary shadow-sm" onclick="aplicarFiltroRapido('hoy')" title="Ver registros de hoy" style="border: 2px solid #0d6efd;">
                            <i class="fas fa-clock"></i>
                        </button>
                    </div>
                    <small class="form-text text-muted"><i class="fas fa-info-circle me-1"></i>Usa el reloj para ver solo hoy</small>
                </div>
            </form>
        </div>
    </div>

    <!-- Indicadores de Filtros Activos -->
    {% if usuario_filtro or fecha_desde or fecha_hasta %}
    <div class="alert alert-info alert-dismissible fade show d-flex align-items-center mb-3" role="alert" style="border-left: 4px solid #F37021;">
        <i class="fas fa-filter me-3" style="color: #F37021; font-size: 1.5rem;"></i>
        <div class="flex-grow-1">
            <strong>Filtros activos:</strong>
            {% if usuario_filtro %}
                <span class="badge bg-primary ms-2">
                    <i class="fas fa-user me-1"></i>
                    Usuario: {% for u in usuarios %}{% if u.id|stringformat:"s" == usuario_filtro %}{{ u.username }}{% endif %}{% endfor %}
                </span>
            {% endif %}
            {% if fecha_desde %}
                <span class="badge bg-success ms-2">
                    <i class="fas fa-calendar-alt me-1"></i>Desde: {{ fecha_desde }}
                </span>
            {% endif %}
            {% if fecha_hasta %}
                <span class="badge bg-success ms-2">
                    <i class="fas fa-calendar-check me-1"></i>Hasta: {{ fecha_hasta }}
                </span>
            {% endif %}
        </div>
        <a href="{% url 'registro_auditoria' %}" class="btn btn-sm btn-outline-secondary ms-3">
            <i class="fas fa-times me-1"></i>Quitar filtros
        </a>
    </div>
    {% endif %}

    <!-- Tab Content -->
    <div class="tab-content" id="auditoriaTabsContent">
        <!-- TAB: TODAS -->
        <div class="tab-pane fade show active" id="todas" role="tabpanel">
            {% include 'calificaciones/partials/_tabla_auditoria.html' with logs=logs titulo="Todas las Acciones" %}
        </div>

        <!-- TAB: CRUD -->
        <div class="tab-pane fade" id="crud" role="tabpanel">
            {% include 'calificaciones/partials/_tabla_auditoria.html' with logs=logs_crud titulo="Operaciones CRUD" %}
        </div>

        <!-- TAB: SESIONES -->
        <div class="tab-pane fade" id="sesiones" role="tabpanel">
            {% include 'calificaciones/partials/_tabla_auditoria.html' with logs=logs_sesiones titulo="Inicios y Cierres de Sesi칩n" %}
        </div>

        <!-- TAB: CARGAS MASIVAS -->
        <div class="tab-pane fade" id="cargas" role="tabpanel">
            {% include 'calificaciones/partials/_tabla_auditoria.html' with logs=logs_cargas titulo="Cargas Masivas" %}
        </div>
    </div>
</div>

<script>
// ========================================
// FUNCIONES DE FILTROS INTELIGENTES
// ========================================

// Limpiar todos los filtros
function limpiarFiltros() {
    window.location.href = '{% url "registro_auditoria" %}';
}

// Aplicar filtros r치pidos predefinidos
function aplicarFiltroRapido(tipo) {
    const form = document.getElementById('filtrosForm');
    const hoy = new Date().toISOString().split('T')[0];
    
    switch(tipo) {
        case 'hoy':
            document.querySelector('input[name="fecha_desde"]').value = hoy;
            document.querySelector('input[name="fecha_hasta"]').value = hoy;
            form.submit();
            break;
        case 'semana':
            const hace7dias = new Date();
            hace7dias.setDate(hace7dias.getDate() - 7);
            document.querySelector('input[name="fecha_desde"]').value = hace7dias.toISOString().split('T')[0];
            document.querySelector('input[name="fecha_hasta"]').value = hoy;
            form.submit();
            break;
        case 'mes':
            const hace30dias = new Date();
            hace30dias.setDate(hace30dias.getDate() - 30);
            document.querySelector('input[name="fecha_desde"]').value = hace30dias.toISOString().split('T')[0];
            document.querySelector('input[name="fecha_hasta"]').value = hoy;
            form.submit();
            break;
    }
}

// Mantener la categor칤a activa al filtrar
document.addEventListener('DOMContentLoaded', function() {
    const urlParams = new URLSearchParams(window.location.search);
    const categoria = urlParams.get('categoria');
    
    if (categoria && categoria !== 'todas') {
        const tab = document.querySelector(`#${categoria}-tab`);
        if (tab) {
            const bsTab = new bootstrap.Tab(tab);
            bsTab.show();
        }
    }
    
    // Actualizar input hidden al cambiar de tab
    document.querySelectorAll('button[data-bs-toggle="tab"]').forEach(button => {
        button.addEventListener('shown.bs.tab', function(e) {
            const tabId = e.target.id.replace('-tab', '');
            document.getElementById('categoriaInput').value = tabId;
        });
    });
    
    // Validaci칩n de fechas
    const fechaDesde = document.querySelector('input[name="fecha_desde"]');
    const fechaHasta = document.querySelector('input[name="fecha_hasta"]');
    
    fechaDesde.addEventListener('change', function() {
        fechaHasta.setAttribute('min', this.value);
        if (fechaHasta.value && fechaHasta.value < this.value) {
            fechaHasta.value = this.value;
        }
    });
    
    fechaHasta.addEventListener('change', function() {
        fechaDesde.setAttribute('max', this.value);
        if (fechaDesde.value && fechaDesde.value > this.value) {
            fechaDesde.value = this.value;
        }
    });
    
    // Animaci칩n al aplicar filtros
    const form = document.getElementById('filtrosForm');
    form.addEventListener('submit', function() {
        const submitBtn = form.querySelector('button[type="submit"]');
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Buscando...';
        submitBtn.disabled = true;
    });
});
</script>

{% endblock %}